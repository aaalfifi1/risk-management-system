<!-- المسار: templates/reports.html (الكود الكامل والصحيح - مع تصحيح صلاحيات الأرشفة) -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير - نظام إدارة المخاطر</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">
    <style>
        :root { --dark-blue: #1a2a45; --medium-blue: #273c5e; --light-text: #f8f9fa; --border-color: #4f5f7d; --accent-yellow: #ffc107; }
        body { background-color: var(--dark-blue ); color: var(--light-text); font-family: 'Tajawal', sans-serif; }
        .navbar-custom { background-color: var(--medium-blue); }
        .navbar-brand { color: var(--accent-yellow) !important; font-weight: bold; }
        .card { background-color: var(--medium-blue); border: 1px solid var(--border-color); }
        .card-title i { font-size: 2.5rem; color: var(--accent-yellow); }
        .btn-upload { background-color: var(--accent-yellow); color: var(--dark-blue); font-weight: bold; border: none; }
        .list-group-item { background-color: var(--dark-blue); border-color: var(--border-color); color: var(--light-text); display: flex; justify-content: space-between; align-items: center; }
        .file-info { display: flex; flex-direction: column; align-items: flex-start; }
        .file-info a { color: var(--light-text); text-decoration: none; font-size: 1rem; }
        .file-info a:hover { color: var(--accent-yellow); }
        .file-date { font-size: 0.8rem; color: #adb5bd; }
        .action-icon { cursor: pointer; font-size: 1.2rem; margin: 0 5px; }
        .action-icon.delete { color: #dc3545; }
        .action-icon.delete:hover { color: #ff5c6c; }
        .action-icon.archive { color: #ffc107; }
        .action-icon.archive:hover { color: #ffe082; }
        .action-icon.restore { color: #198754; }
        .action-icon.restore:hover { color: #20c997; }
        .modal-content { background-color: var(--medium-blue); color: var(--light-text); }
        .modal-header, .modal-footer { border-color: var(--border-color); }
        .form-control { background-color: var(--dark-blue); color: var(--light-text); border-color: var(--border-color); }
        .iziToast.custom-toast, .iziToast.custom-toast-question { background-color: var(--dark-blue); border: 1px solid var(--accent-yellow); }
        .iziToast.custom-toast .iziToast-title, .iziToast.custom-toast-question .iziToast-title { color: var(--light-text); }
        .iziToast.custom-toast .iziToast-message, .iziToast.custom-toast-question .iziToast-message { color: var(--light-text); font-size: 14px; text-align: right; }
        .iziToast.custom-toast-question .iziToast-buttons button { background-color: var(--medium-blue); color: var(--light-text); border: 1px solid var(--border-color); }
        .iziToast.custom-toast-question .iziToast-buttons button:hover { background-color: #3a4f70; }
        .archived-section { background-color: rgba(255, 193, 7, 0.1); border: 1px solid var(--accent-yellow); border-radius: 15px; padding: 1.5rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('home') }}">نظام إدارة المخاطر</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('stats') }}">لوحة التحكم</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('risk_register') }}">سجل المخاطر</a></li>
                    {% if current_user.username == 'admin' %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('audit_log') }}">سجل التغييرات</a></li>
                    {% endif %}
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('static', filename='risk_management_plan_2025.pdf') }}" target="_blank"><i class="bi bi-file-earmark-text-fill"></i> خطة إدارة المخاطر</a></li>
                    <li class="nav-item"><a class="nav-link active" href="{{ url_for('reports') }}">التقارير</a></li>
                    <li class="nav-item"><a class="nav-link" href="mailto:Grc@nu.edu.sa"><i class="bi bi-envelope-fill"></i> تواصل معنا</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">مرحباً, {{ current_user.username }}</a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">تسجيل الخروج</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4">مركز التقارير</h2>

        {% if current_user.username == 'admin' %}
            <div class="row g-4">
                <div class="col-lg-3 col-md-6"><div class="card text-center p-3 h-100"><div class="card-body d-flex flex-column"><h5 class="card-title text-white"><i class="bi bi-calendar-range-fill d-block mb-3"></i>تقارير ربع سنوية</h5><p class="card-text text-white">تقارير الإدارة الرسمية.</p><button class="btn btn-upload mt-auto" data-bs-toggle="modal" data-bs-target="#uploadModal" data-report-type="quarterly"><i class="bi bi-cloud-arrow-up-fill"></i> رفع</button><hr class="my-4"><h6>الملفات:</h6><ul class="list-group mt-3" id="quarterly-files-list"></ul></div></div></div>
                <div class="col-lg-3 col-md-6"><div class="card text-center p-3 h-100"><div class="card-body d-flex flex-column"><h5 class="card-title text-white"><i class="bi bi-calendar2-event-fill d-block mb-3"></i>تقارير نصف سنوية</h5><p class="card-text text-white">تقارير الإدارة الرسمية.</p><button class="btn btn-upload mt-auto" data-bs-toggle="modal" data-bs-target="#uploadModal" data-report-type="semi_annual"><i class="bi bi-cloud-arrow-up-fill"></i> رفع</button><hr class="my-4"><h6>الملفات:</h6><ul class="list-group mt-3" id="semi_annual-files-list"></ul></div></div></div>
                <div class="col-lg-3 col-md-6"><div class="card text-center p-3 h-100"><div class="card-body d-flex flex-column"><h5 class="card-title text-white"><i class="bi bi-calendar-check-fill d-block mb-3"></i>تقارير سنوية</h5><p class="card-text text-white">تقارير الإدارة الرسمية.</p><button class="btn btn-upload mt-auto" data-bs-toggle="modal" data-bs-target="#uploadModal" data-report-type="annual"><i class="bi bi-cloud-arrow-up-fill"></i> رفع</button><hr class="my-4"><h6>الملفات:</h6><ul class="list-group mt-3" id="annual-files-list"></ul></div></div></div>
                <div class="col-lg-3 col-md-6"><div class="card text-center p-3 h-100"><div class="card-body d-flex flex-column"><h5 class="card-title text-white"><i class="bi bi-person-workspace d-block mb-3"></i>تقارير رواد المخاطر</h5><p class="card-text text-white">الملفات المرفوعة من الفريق.</p><button class="btn btn-upload mt-auto disabled" disabled><i class="bi bi-cloud-arrow-up-fill"></i> رفع</button><hr class="my-4"><h6>الملفات:</h6><ul class="list-group mt-3" id="risk_champion-files-list"></ul></div></div></div>
            </div>
            <div id="archived-section-container" class="mt-5" style="display: none;">
                <div class="archived-section">
                    <h4 class="mb-3"><i class="bi bi-archive-fill"></i> سلة المحذوفات (التقارير المؤرشفة)</h4>
                    <ul class="list-group" id="archived-files-list"></ul>
                </div>
            </div>

        {% elif current_user.username == 'testuser' %}
            <div class="row justify-content-center g-4">
                <div class="col-lg-4 col-md-6">
                    <div class="card text-center p-3 h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-white"><i class="bi bi-file-earmark-arrow-up-fill d-block mb-3"></i>تقارير رائد المخاطر</h5>
                            <p class="card-text text-white">هنا يمكنك رفع تقاريرك الخاصة المتعلقة بالمخاطر التي تتابعها.</p>
                            <button class="btn btn-upload mt-auto" data-bs-toggle="modal" data-bs-target="#uploadModal" data-report-type="risk_champion">
                                <i class="bi bi-cloud-arrow-up-fill"></i> رفع تقرير جديد
                            </button>
                            <hr class="my-4" style="border-color: var(--border-color);">
                            <h6>الملفات المرفوعة:</h6>
                            <ul class="list-group mt-3" id="risk_champion-files-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="uploadForm"><div class="modal-header"><h5 class="modal-title" id="uploadModalLabel">رفع تقرير جديد</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="reportType" name="report_type"><div class="mb-3"><label for="reportFile" class="form-label">اختر الملف</label><input class="form-control" type="file" id="reportFile" name="report_file" required></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary">رفع</button></div></form></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function ( ) {
            const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
            const uploadForm = document.getElementById('uploadForm');
            const uploadModalElement = document.getElementById('uploadModal');
            const isAdmin = "{{ current_user.username }}" === "admin";
            const isRiskChampion = "{{ current_user.username }}" === "testuser";

            function showToast(message, type = 'success') { 
                iziToast.destroy();
                iziToast[type]({ title: 'تنبيه', message: message, position: 'bottomLeft', rtl: true, class: 'custom-toast' }); 
            }
            
            async function fetchAndRenderFiles() {
                try {
                    const response = await fetch('/api/reports/files');
                    const data = await response.json();
                    if (data.success) {
                        if (isAdmin) {
                            updateFileList('quarterly', data.files.quarterly);
                            updateFileList('semi_annual', data.files.semi_annual);
                            updateFileList('annual', data.files.annual);
                            updateFileList('risk_champion', data.files.risk_champion);
                            updateFileList('archived', data.archived_files, true);
                        } else if (isRiskChampion) {
                            updateFileList('risk_champion', data.files.risk_champion);
                        }
                    }
                } catch (error) { showToast('فشل في تحميل قائمة الملفات.', 'error'); }
            }

            function updateFileList(type, files, isArchivedList = false) {
                const listId = isArchivedList ? 'archived-files-list' : `${type}-files-list`;
                const listElement = document.getElementById(listId);
                if (!listElement) return;

                if (isArchivedList) {
                    const container = document.getElementById('archived-section-container');
                    if (files && files.length > 0) {
                        container.style.display = 'block';
                    } else {
                        container.style.display = 'none';
                    }
                }
                
                listElement.innerHTML = '';
                if (files && files.length > 0) {
                    files.forEach(file => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        
                        let iconsHtml = '';
                        if (isArchivedList) {
                            iconsHtml = `
                                <i class="bi bi-arrow-counterclockwise action-icon restore" title="استعادة الملف" onclick="confirmAction('restore', ${file.id})"></i>
                                <i class="bi bi-trash3-fill action-icon delete" title="حذف نهائي" onclick="confirmAction('delete', ${file.id})"></i>
                            `;
                        } else {
                            if (isAdmin) {
                                iconsHtml = `<i class="bi bi-archive-fill action-icon archive" title="أرشفة الملف" onclick="confirmAction('archive', ${file.id})"></i>`;
                            } else if (isRiskChampion) {
                                // رائد المخاطر يرى أيقونة الأرشفة فقط لتقاريره
                                iconsHtml = `<i class="bi bi-archive-fill action-icon archive" title="أرشفة الملف" onclick="confirmAction('archive', ${file.id})"></i>`;
                            }
                        }

                        li.innerHTML = `
                            <div class="file-info">
                                <a href="/reports_uploads/${file.type}/${file.name}" target="_blank"><i class="bi bi-file-earmark-text"></i> ${file.name}</a>
                                <span class="file-date">تاريخ الرفع: ${file.modified_date}</span>
                            </div>
                            <div>${iconsHtml}</div>`;
                        listElement.appendChild(li);
                    });
                } else {
                    if (!isArchivedList) {
                        listElement.innerHTML = '<li class="list-group-item">لا توجد ملفات حاليًا.</li>';
                    }
                }
            }

            window.confirmAction = function(action, reportId) {
                let title = '', message = '', url = '';
                switch(action) {
                    case 'archive':
                        title = 'تأكيد الأرشفة';
                        message = 'هل أنت متأكد من أرشفة هذا الملف؟';
                        url = `/api/reports/${reportId}/archive`;
                        break;
                    case 'restore':
                        title = 'تأكيد الاستعادة';
                        message = 'هل أنت متأكد من استعادة هذا الملف؟';
                        url = `/api/reports/${reportId}/restore`;
                        break;
                    case 'delete':
                        title = 'تأكيد الحذف النهائي';
                        message = 'هل أنت متأكد من حذف هذا الملف نهائياً؟ لا يمكن التراجع عن هذا الإجراء.';
                        url = `/api/reports/${reportId}/delete`;
                        break;
                }
                
                iziToast.question({
                    timeout: 20000, close: false, overlay: true, id: 'question', zindex: 999,
                    title: title, message: message, position: 'center', rtl: true, class: 'custom-toast-question',
                    buttons: [
                        ['<button><b><i class="bi bi-check-circle-fill"></i> نعم</b></button>', async function (instance, toast) {
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                            const method = action === 'delete' ? 'DELETE' : 'POST';
                            await sendRequest(url, method);
                        }, true], 
                        ['<button><i class="bi bi-x-lg"></i> لا</button>', function (instance, toast) { 
                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button'); 
                        }]
                    ]
                });
            }

            async function sendRequest(url, method) {
                try {
                    const response = await fetch(url, { method: method });
                    const result = await response.json();
                    showToast(result.message, result.success ? 'success' : 'error');
                    if (result.success) fetchAndRenderFiles();
                } catch (error) { showToast('فشل الاتصال بالخادم.', 'error'); }
            }

            uploadModalElement.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const reportType = button.getAttribute('data-report-type');
                const modalTitle = uploadModalElement.querySelector('.modal-title');
                uploadModalElement.querySelector('#reportType').value = reportType;
                const typeText = {'quarterly': 'ربع سنوي', 'semi_annual': 'نصف سنوي', 'annual': 'سنوي', 'risk_champion': 'رائد المخاطر'};
                modalTitle.textContent = `رفع تقرير ${typeText[reportType] || ''}`;
            });

            uploadForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                if (!document.getElementById('reportFile').files.length) { showToast('الرجاء اختيار ملف أولاً.', 'warning'); return; }
                try {
                    const response = await fetch('/api/reports/upload', { method: 'POST', body: formData });
                    const result = await response.json();
                    if (result.success) { showToast(result.message, 'success'); uploadModal.hide(); fetchAndRenderFiles(); uploadForm.reset(); } else { showToast(result.message || 'حدث خطأ أثناء الرفع.', 'error'); }
                } catch (error) { showToast('فشل الاتصال بالخادم.', 'error'); }
            });

            fetchAndRenderFiles();
        });
    </script>
</body>
</html>
