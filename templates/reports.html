<!-- ======================================================================= -->
<!-- == reports.html - الكود الكامل والنهائي مع تعديل التوقيت == -->
<!-- ======================================================================= -->
{% extends "base.html" %}

{% block title %}التقارير - نظام إدارة المخاطر{% endblock %}

{% block styles %}
    <style>
        .card { background-color: var(--medium-blue); border: 1px solid var(--border-color); }
        .card .card-title, .card .card-text, .card h6 { color: #0d6efd !important; }
        .card-title i { font-size: 2.5rem; color: var(--accent-yellow); }
        .btn-upload { background-color: var(--accent-yellow); color: var(--dark-blue); font-weight: bold; border: none; }
        .list-group-item { background-color: var(--dark-blue); border-color: var(--border-color); color: var(--light-text); display: flex; justify-content: space-between; align-items: center; }
        .file-info a { color: var(--light-text); text-decoration: none; font-size: 1rem; }
        .file-info a:hover { color: var(--accent-yellow); }
        .file-date { font-size: 0.8rem; color: #adb5bd; }
        .action-icon { cursor: pointer; font-size: 1.2rem; margin: 0 5px; }
        .action-icon.delete { color: #dc3545; }
        .action-icon.archive { color: #ffc107; }
        .action-icon.restore { color: #198754; }
        .archived-section { background-color: rgba(255, 193, 7, 0.1); border: 1px solid var(--accent-yellow); border-radius: 15px; padding: 1.5rem; }
    </style>
{% endblock %}

{% block content %}
    <h2 class="mb-4">مركز التقارير</h2>
    {% if current_user.username == 'admin' %}
     <div class="row">
    <!-- إظهار التقارير الدورية للمدير فقط -->
    {% if current_user.role.name == 'Admin' %}
        <div class="col-md-3 mb-4">
            <div class="card report-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-quarter fs-1 text-primary mb-3"></i>
                    <h5 class="card-title">تقارير ربع سنوية</h5>
                    <p class="card-text small">تقارير الإدارة الرسمية</p>
                    <button class="btn btn-warning w-100" onclick="uploadFile('quarterly')"><i class="bi bi-upload"></i> رفع</button>
                    <hr>
                    <div id="quarterly-files" class="files-list"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card report-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-calendar2-half fs-1 text-info mb-3"></i>
                    <h5 class="card-title">تقارير نصف سنوية</h5>
                    <p class="card-text small">تقارير الإدارة الرسمية</p>
                    <button class="btn btn-warning w-100" onclick="uploadFile('semi_annual')"><i class="bi bi-upload"></i> رفع</button>
                    <hr>
                    <div id="semi_annual-files" class="files-list"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card report-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-event fs-1 text-success mb-3"></i>
                    <h5 class="card-title">تقارير سنوية</h5>
                    <p class="card-text small">تقارير الإدارة الرسمية</p>
                    <button class="btn btn-warning w-100" onclick="uploadFile('annual')"><i class="bi bi-upload"></i> رفع</button>
                    <hr>
                    <div id="annual-files" class="files-list"></div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- إظهار تقارير رواد المخاطر للجميع (المدير ورائد المخاطر) -->
    <div class="col-md-3 mb-4">
        <div class="card report-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-person-workspace fs-1 text-warning mb-3"></i>
                <h5 class="card-title">
                    {% if current_user.role.name == 'Admin' %}
                        تقارير رواد المخاطر
                    {% else %}
                        تقاريري المرفوعة
                    {% endif %}
                </h5>
                <p class="card-text small">الملفات المرفوعة من الفريق</p>
                <button class="btn btn-warning w-100" onclick="uploadFile('risk_champion')"><i class="bi bi-upload"></i> رفع</button>
                <hr>
                <div id="risk_champion-files" class="files-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- إظهار سلة المحذوفات للمدير فقط -->
{% if current_user.role.name == 'Admin' %}
    <div id="archived-section" class="mt-5" style="display: none;">
        <h3 class="mb-3"><i class="bi bi-archive-fill"></i> سلة المحذوفات (التقارير المؤرشفة)</h3>
        <ul id="archived-files-list" class="list-group"></ul>
    </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        const uploadForm = document.getElementById('uploadForm');
        const uploadModalElement = document.getElementById('uploadModal');
        async function fetchAndRenderFiles() {
            try {
                const response = await fetch('/api/reports/files');
                const data = await response.json();
                if (data.success) {
                    if (isAdmin) {
                        updateFileList('quarterly', data.files.quarterly);
                        updateFileList('semi_annual', data.files.semi_annual);
                        updateFileList('annual', data.files.annual);
                        updateFileList('risk_champion', data.files.risk_champion);
                        updateFileList('archived', data.archived_files, true);
                    } else if (userRole === "testuser") {
                        updateFileList('risk_champion', data.files.risk_champion);
                    }
                }
            } catch (error) { showToast('فشل في تحميل قائمة الملفات.', 'error'); }
        }
        function updateFileList(type, files, isArchivedList = false) {
            const listId = isArchivedList ? 'archived-files-list' : `${type}-files-list`;
            const listElement = document.getElementById(listId);
            if (!listElement) return;
            if (isArchivedList) {
                const container = document.getElementById('archived-section-container');
                if (files && files.length > 0) { container.style.display = 'block'; } else { container.style.display = 'none'; }
            }
            listElement.innerHTML = '';
            if (files && files.length > 0) {
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    let iconsHtml = '';
                    if (isArchivedList) { iconsHtml = `<i class="bi bi-arrow-counterclockwise action-icon restore" title="استعادة الملف" onclick="confirmAction('restore', ${file.id})"></i><i class="bi bi-trash3-fill action-icon delete" title="حذف نهائي" onclick="confirmAction('delete', ${file.id})"></i>`; }
                    else { if (isAdmin || userRole === "testuser") { iconsHtml = `<i class="bi bi-archive-fill action-icon archive" title="أرشفة الملف" onclick="confirmAction('archive', ${file.id})"></i>`; } }
                    
                    // --- [التعديل الوحيد هنا] ---
                    li.innerHTML = `<div class="file-info"><a href="/reports_uploads/${file.type}/${file.name}" target="_blank"><i class="bi bi-file-earmark-text"></i> ${file.name}</a><span class="file-date">تاريخ الرفع: ${toKsaTime(file.modified_date)}</span></div><div>${iconsHtml}</div>`;
                    
                    listElement.appendChild(li);
                });
            } else { if (!isArchivedList) { listElement.innerHTML = '<li class="list-group-item">لا توجد ملفات حاليًا.</li>'; } }
        }
        window.confirmAction = function(action, reportId) {
            let title = '', message = '', url = '';
            switch(action) {
                case 'archive': title = 'تأكيد الأرشفة'; message = 'هل أنت متأكد من أرشفة هذا الملف؟'; url = `/api/reports/${reportId}/archive`; break;
                case 'restore': title = 'تأكيد الاستعادة'; message = 'هل أنت متأكد من استعادة هذا الملف؟'; url = `/api/reports/${reportId}/restore`; break;
                case 'delete': title = 'تأكيد الحذف النهائي'; message = 'هل أنت متأكد من حذف هذا الملف نهائياً؟'; url = `/api/reports/${reportId}/delete`; break;
            }
            iziToast.question({
                timeout: 20000, close: false, overlay: true, id: 'question', zindex: 999, title: title, message: message, position: 'center', rtl: true, class: 'custom-toast-question',
                buttons: [
                    ['<button><b>نعم</b></button>', async function (instance, toast) { instance.hide({ transitionOut: 'fadeOut' }, toast, 'button'); const method = action === 'delete' ? 'DELETE' : 'POST'; await sendRequest(url, method); }, true], 
                    ['<button>لا</button>', function (instance, toast) { instance.hide({ transitionOut: 'fadeOut' }, toast, 'button'); }]
                ]
            });
        }
        async function sendRequest(url, method) {
            try {
                const response = await fetch(url, { method: method });
                const result = await response.json();
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) fetchAndRenderFiles();
            } catch (error) { showToast('فشل الاتصال بالخادم.', 'error'); }
        }
        uploadModalElement.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const reportType = button.getAttribute('data-report-type');
            const modalTitle = uploadModalElement.querySelector('.modal-title');
            uploadModalElement.querySelector('#reportType').value = reportType;
            const typeText = {'quarterly': 'ربع سنوي', 'semi_annual': 'نصف سنوي', 'annual': 'سنوي', 'risk_champion': 'رائد المخاطر'};
            modalTitle.textContent = `رفع تقرير ${typeText[reportType] || ''}`;
        });
        uploadForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            if (!document.getElementById('reportFile').files.length) { showToast('الرجاء اختيار ملف أولاً.', 'warning'); return; }
            try {
                const response = await fetch('/api/reports/upload', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) { showToast(result.message, 'success'); uploadModal.hide(); fetchAndRenderFiles(); uploadForm.reset(); } else { showToast(result.message || 'حدث خطأ أثناء الرفع.', 'error'); }
            } catch (error) { showToast('فشل الاتصال بالخادم.', 'error'); }
        });
        fetchAndRenderFiles();
    });
</script>
{% endblock %}

