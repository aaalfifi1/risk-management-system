{% extends "base.html" %}

{% block title %}لوحة التحكم - نظام إدارة المخاطر{% endblock %}

{% block styles %}
    <style>
        /* ... (كل التنسيقات السابقة تبقى كما هي) ... */

        /* --- [بداية الإصلاح] تعديل تنسيقات شريط المؤشرات --- */
        .kpi-ticker-container {
            background-color: #273c5e;
            border-radius: 10px;
            padding: 10px 0;
            overflow: hidden;
            white-space: nowrap;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .kpi-ticker-content {
            display: inline-block;
            /* سرعة الحركة تعتمد على هذا الرقم، كلما زاد كان أبطأ */
            animation: ticker-scroll 40s linear infinite;
            color: #f8f9fa;
            padding-left: 100%; /* هذا مهم لبدء الحركة من خارج الشاشة */
        }
        .kpi-item {
            display: inline-block;
            /* زيادة المسافة لضمان عدم وجود فراغات مرئية أثناء التكرار */
            margin-right: 150px; 
            font-size: 0.9rem;
        }
        .kpi-item strong {
            color: var(--accent-yellow);
            font-size: 1rem;
        }
        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        /* --- [نهاية الإصلاح] --- */
    </style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3 header-controls">
        <h2 class="mb-0">لوحة التحكم التحليلية</h2>
        <div>
            <button id="tv-mode" class="btn btn-sm btn-warning"><i class="bi bi-tv-fill"></i> وضع العرض</button>
            <button id="export-pdf" class="btn btn-sm btn-info"><i class="bi bi-file-earmark-pdf-fill"></i> تصدير PDF</button>
            <button id="reset-filter" class="btn btn-sm btn-outline-light" style="display: none;"><i class="bi bi-arrow-clockwise"></i> إعادة تعيين الفلتر</button>
        </div>
    </div>

    <!-- --- حاوية شريط المؤشرات --- -->
    <div class="kpi-ticker-container">
        <div id="kpi-ticker-content" class="kpi-ticker-content">
            <!-- سيتم ملء المؤشرات هنا بواسطة JavaScript -->
        </div>
    </div>

    <div id="dashboard-to-print">
        <!-- ... (باقي محتوى HTML يبقى كما هو بدون تغيير) ... -->
    </div>
{% endblock %}

{% block scripts %}
    <!-- ... (كل السكريبتات السابقة تبقى كما هي) ... -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ... (كل الكود السابق يبقى كما هو) ...

            // --- [بداية الإصلاح] تعديل دالة عرض شريط المؤشرات ---
            function renderKpiTicker(kpiData) {
                const tickerContent = document.getElementById('kpi-ticker-content');
                // نستخدم قيمة افتراضية فارغة لضمان عدم حدوث أخطاء
                const data = kpiData || {}; 
                
                const items = [
                    // نستخدم || '...' كقيمة افتراضية لضمان عرض قيمة دائماً
                    `<span class="kpi-item">متوسط عمر المخاطر: <strong>${data.avg_risk_age || '...'} يوم</strong></span>`,
                    `<span class="kpi-item">كفاءة الإغلاق (شهري): <strong>${data.closure_rate_this_month || '...'}%</strong></span>`,
                    `<span class="kpi-item">أخطر فئة حالياً: <strong>${data.most_dangerous_category || '...'}</strong></span>`,
                    `<span class="kpi-item">المخاطر المترابطة: <strong>${data.linked_risks_count || '...'}</strong></span>`
                ];

                // نكرر المحتوى 5 مرات لضمان أن العرض الإجمالي أطول بكثير من الشاشة
                // هذا هو مفتاح الحركة المستمرة والسلسة
                tickerContent.innerHTML = items.join('').repeat(5);
            }
            // --- [نهاية الإصلاح] ---

            // ... (باقي الكود يبقى كما هو) ...
            
            function updateDashboard(stats) {
                // ... (الكود هنا يبقى كما هو) ...
                
                // استدعاء دوال العرض مع التأكد من وجود البيانات
                if (!isFiltered) {
                    renderKpiTicker(stats.kpi_data || {});
                }
                renderMatrixChart(stats.matrix_data || []);
                // ... (باقي استدعاءات دوال العرض تبقى كما هي) ...
            }

            fetchStats();
        });
    </script>
{% endblock %}
