{% extends "base.html" %}

{% block title %}لوحة التحكم - نظام إدارة المخاطر{% endblock %}

{% block styles %}
<style>
    /* --- [تقنية جديدة] تنسيقات شريط مؤشرات الأداء --- */
    .kpi-ticker-wrap {
        background-color: #1a2a45;
        width: 100%;
        overflow: hidden;
        height: 2.5rem;
        padding: 0;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        box-sizing: border-box;
        margin-bottom: 1.5rem;
        /* خاصية مهمة لمنع القفزات */
        -webkit-font-smoothing: antialiased;
    }

    .kpi-ticker-wrap .ticker-content {
        display: flex;
        width: fit-content; /* نجعل العرض يناسب المحتوى */
    }

    .kpi-ticker-wrap .ticker-content.animate {
        /* مدة الحركة ستُحسب بواسطة JavaScript */
        animation: ticker-animation var(--animation-duration, 40s) linear infinite;
    }

    .kpi-ticker-wrap .ticker-content:hover {
        animation-play-state: paused;
    }

    .kpi-ticker-wrap .kpi-item {
        display: flex;
        align-items: center;
        padding: 0 2rem;
        font-size: 0.95rem;
        white-space: nowrap; /* نضمن أن كل عنصر على سطر واحد */
    }

    .kpi-ticker-wrap .kpi-item .kpi-label {
        color: var(--accent-yellow);
        font-weight: bold;
        margin-left: 8px;
    }

    .kpi-ticker-wrap .kpi-item .kpi-value {
        color: var(--light-text);
    }

    @keyframes ticker-animation {
        from {
            transform: translateX(0);
        }
        to {
            /* نحرك بمقدار النصف فقط (عرض المحتوى الأصلي) */
            transform: translateX(-50%);
        }
    }

    /* --- تنسيقات لوحة التحكم الأساسية (بدون تغيير) --- */
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card .card-body { display: flex; align-items: center; justify-content: space-between; }
    .stat-icon { font-size: 3rem; opacity: 0.6; }
    .chart-container { background-color: #273c5e; padding: 20px; border-radius: 15px; height: 420px; display: flex; flex-direction: column; }
    .chart-container canvas { flex-grow: 1; min-height: 0; }
    .card-title-white { color: #ffffff; font-weight: bold; }
    .percentage-text { color: var(--accent-yellow); font-weight: bold; font-size: 0.9rem; margin-right: 8px; }
    .stat-value-container { display: flex; align-items: baseline; }
    #matrixChart {
        background-image: 
            linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: calc(100% / 5) calc(100% / 5);
    }
    .reset-filter-btn { position: absolute; top: 15px; left: 20px; z-index: 10; }
    body.tv-mode .sidebar, 
    body.tv-mode .navbar,
    body.tv-mode .header-controls { display: none !important; }
    body.tv-mode .main-content { padding: 20px !important; margin: 0 !important; max-width: 100% !important; }
    .watchlist-container { background-color: rgba(220, 53, 69, 0.15); border: 1px solid rgba(220, 53, 69, 0.4); padding: 20px; border-radius: 15px; height: 420px; display: flex; flex-direction: column; }
    .watchlist-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background-color 0.2s; }
    .watchlist-item:hover { background-color: rgba(220, 53, 69, 0.3); }
    .watchlist-item:last-child { border-bottom: none; }
    .watchlist-title { font-weight: bold; color: #f8f9fa; }
    .watchlist-code { font-size: 0.85rem; color: #adb5bd; }
    .watchlist-level { font-size: 0.9rem; font-weight: bold; padding: 0.3em 0.6em; border-radius: 5px; }
    .watchlist-placeholder { display: flex; justify-content: center; align-items: center; height: 100%; color: rgba(255, 255, 255, 0.5); font-style: italic; }
</style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3 header-controls">
        <h2 class="mb-0">لوحة التحكم التحليلية</h2>
        <div>
            <button id="tv-mode" class="btn btn-sm btn-warning"><i class="bi bi-tv-fill"></i> وضع العرض</button>
            <button id="export-pdf" class="btn btn-sm btn-info"><i class="bi bi-file-earmark-pdf-fill"></i> تصدير PDF</button>
            <button id="reset-filter" class="btn btn-sm btn-outline-light" style="display: none;"><i class="bi bi-arrow-clockwise"></i> إعادة تعيين الفلتر</button>
        </div>
    </div>

    <div id="dashboard-to-print">
        <!-- هيكل شريط مؤشرات الأداء -->
        <div class="kpi-ticker-wrap" id="kpi-ticker-container" style="display: none;">
            <div class="ticker-content" id="kpi-ticker-content">
                <!-- البيانات تملأ هنا بواسطة JavaScript -->
            </div>
        </div>

        <!-- الصف الأول: البطاقات الخمس -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-5 g-4 mb-4">
            <!-- ... (البطاقات كما هي) ... -->
        </div>

        <!-- هيكل الشبكة (Grid) للرسوم البيانية -->
        <div class="row g-4">
            <!-- ... (الرسوم البيانية كما هي) ... -->
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function ( ) {
            // ... (الكود الأولي لتعريف المتغيرات والأزرار لم يتغير) ...

            async function fetchStats(filters = {}) {
                // ... (الدالة كما هي) ...
            }

            // --- [دالة الشريط الجديدة كلياً] ---
            function renderKpiTicker(kpiData) {
                const tickerContainer = document.getElementById('kpi-ticker-container');
                const tickerContent = document.getElementById('kpi-ticker-content');

                if (!tickerContainer || !tickerContent) return;
                if (!kpiData || !Array.isArray(kpiData) || kpiData.length === 0) {
                    tickerContainer.style.display = 'none';
                    return;
                }

                let itemsHtml = '';
                kpiData.forEach(kpi => {
                    if (kpi && typeof kpi === 'object' && kpi.label && kpi.value !== undefined) {
                        itemsHtml += `<div class="kpi-item"><span class="kpi-label">${kpi.label}</span><span class="kpi-value">${kpi.value}</span></div>`;
                    }
                });

                if (itemsHtml === '') {
                    tickerContainer.style.display = 'none';
                    return;
                }

                // الخدعة هنا: نضع المحتوى مرتين
                tickerContent.innerHTML = itemsHtml + itemsHtml;
                tickerContainer.style.display = 'block';
                
                // نحسب عرض المحتوى الأصلي (النصف)
                const contentWidth = tickerContent.scrollWidth / 2;
                
                // نضبط مدة الحركة بناءً على العرض
                const animationDuration = contentWidth / 50; // سرعة 50 بكسل في الثانية
                tickerContent.style.setProperty('--animation-duration', `${animationDuration}s`);

                // نبدأ الحركة
                tickerContent.classList.add('animate');
            }

            // ... (بقية دوال الرسوم البيانية لم تتغير) ...

            function updateDashboard(stats) {
                // ... (الدالة كما هي) ...
            }

            fetchStats();
        });
    </script>
{% endblock %}
